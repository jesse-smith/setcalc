<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Set Calc">
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
  <title>Set Calculator</title>
  <link rel="manifest" href="data:application/json,{%22name%22:%22Set%20Calculator%22,%22short_name%22:%22Set%20Calc%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%231a1a1a%22,%22theme_color%22:%22%231a1a1a%22}">
  <style>
    * {
      box-sizing: border-box;
    }

:root {
  --bg-page: #1a1a1a;
  --bg-section: #2a2a2a;
  --bg-input: #333;
  --border-input: #444;
  --border-focus: #007aff;
  --border-invalid: #ff453a;
  --bg-invalid: #3a2a2a;
  --text-primary: #f0f0f0;
  --text-secondary: #999;
  --text-label: #888;
  --text-error: #ff453a;
  --toggle-bg: #333;
  --toggle-active-bg: #444;
  --shadow: rgba(0,0,0,0.3);
}

@media (prefers-color-scheme: light) {
  :root {
    --bg-page: #f5f5f5;
    --bg-section: white;
    --bg-input: white;
    --border-input: #ddd;
    --border-focus: #007aff;
    --border-invalid: #ff3b30;
    --bg-invalid: #fff5f5;
    --text-primary: #333;
    --text-secondary: #666;
    --text-label: #888;
    --text-error: #ff3b30;
    --toggle-bg: #f0f0f0;
    --toggle-active-bg: white;
    --shadow: rgba(0,0,0,0.1);
  }
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
  background: var(--bg-page);
  color: var(--text-primary);
}

h1 {
  text-align: center;
  margin-bottom: 24px;
  font-weight: 600;
}

.section {
  background: var(--bg-section);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px var(--shadow);
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.input-row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.input-row:last-child {
  margin-bottom: 0;
}

.input-group {
  flex: 1;
}

.input-group label {
  display: block;
  font-size: 12px;
  color: var(--text-label);
  margin-bottom: 4px;
}

.input-group input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-input);
  border-radius: 8px;
  font-size: 16px;
  background: var(--bg-input);
  color: var(--text-primary);
  transition: border-color 0.2s;
}

.input-group input:focus {
  outline: none;
  border-color: var(--border-focus);
}

.input-group input.invalid {
  border-color: var(--border-invalid);
  background-color: var(--bg-invalid);
}

.input-group input.invalid:focus {
  border-color: var(--border-invalid);
}

.input-group select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border-input);
  border-radius: 8px;
  font-size: 16px;
  background: var(--bg-input);
  color: var(--text-primary);
  transition: border-color 0.2s;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  cursor: pointer;
}

.input-group select:focus {
  outline: none;
  border-color: var(--border-focus);
}

.error-message {
  color: var(--text-error);
  font-size: 11px;
  margin-top: 4px;
  min-height: 16px;
}

.toggle-group {
  display: flex;
  background: var(--toggle-bg);
  border-radius: 32px;
  padding: 4px;
  margin-bottom: 16px;
  position: relative;
}

.toggle-group::before {
  content: '';
  position: absolute;
  top: 4px;
  left: 4px;
  width: calc(50% - 4px);
  height: calc(100% - 8px);
  background: var(--toggle-active-bg);
  border-radius: 32px;
  box-shadow: 0 1px 3px var(--shadow);
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  z-index: 0;
}

.toggle-group.mode-reps::before {
  transform: translateX(100%);
}

.toggle-btn {
  flex: 1;
  padding: 8px 12px;
  border: none;
  background: transparent;
  border-radius: 32px;
  font-size: 14px;
  cursor: pointer;
  transition: color 0.2s;
  color: var(--text-secondary);
  position: relative;
  z-index: 1;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}

.toggle-btn:active {
  background: transparent;
}

.toggle-btn:focus {
  outline: none;
}

.toggle-btn:focus-visible {
  outline: none;
}

.toggle-btn.active {
  color: var(--text-primary);
}

.output-section {
  background: linear-gradient(135deg, #007aff, #5856d6);
  color: white;
}

.output-row-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 4px;
  margin-top: 12px;
}

.output-row-label:first-child {
  margin-top: 0;
}

.output-label-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 12px;
  margin-bottom: 4px;
}

.output-label-row .output-row-label {
  margin: 0;
}

.output-row {
  display: flex;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.output-row-last {
  border-bottom: none;
}

.rounding-toggle {
  display: flex;
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 2px;
  position: relative;
}

.rounding-toggle::before {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: calc(33.333% - 1.333px);
  height: calc(100% - 4px);
  background: rgba(255,255,255,0.25);
  border-radius: 10px;
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  z-index: 0;
}

.rounding-toggle.mode-closest::before {
  transform: translateX(100%);
}

.rounding-toggle.mode-up::before {
  transform: translateX(200%);
}

.rounding-toggle-btn {
  flex: 1;
  padding: 3px 10px;
  border: none;
  background: transparent;
  border-radius: 10px;
  font-size: 11px;
  cursor: pointer;
  transition: color 0.2s;
  color: rgba(255,255,255,0.6);
  position: relative;
  z-index: 1;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}

.rounding-toggle-btn:active {
  background: transparent;
}

.rounding-toggle-btn:focus {
  outline: none;
}

.rounding-toggle-btn.active {
  color: white;
}

.output-row span:nth-child(1) {
  flex: 0 0 33.33%; /* or any fixed width */
  text-align: left;
}

.output-row span:nth-child(2) {
  flex: 0 0 33.33%;
  text-align: center;
}

.output-row span:nth-child(3) {
  flex: 0 0 33.33%;
  text-align: right;
}


.output-label {
  font-size: 14px;
  opacity: 0.9;
}

.output-value {
  font-size: 18px;
  font-weight: 600;
}

.hidden {
  display: none;
}

  </style>
</head>
<body>
  <h1>Set Calculator</h1>
  
  <div class="section output-section">
    <div class="output-row-label">Exact</div>
    <div class="output-row">
      <span>
      <span class="output-value" id="outputWeight">--</span>
      <span class="output-label">lbs</span>
      </span>
      <span>
      <span class="output-value" id="outputReps">--</span>
      <span class="output-label">reps</span>
      </span>
      <span>
      <span class="output-value" id="outputRPE">--</span>
      <span class="output-label">RPE</span>
      </span>
    </div>
    <div class="output-label-row">
      <div class="output-row-label">Achievable</div>
      <div class="rounding-toggle mode-closest" id="roundingToggle">
        <button class="rounding-toggle-btn" id="roundDown" onclick="setRoundingMode('down')">Down</button>
        <button class="rounding-toggle-btn active" id="roundClosest" onclick="setRoundingMode('closest')">Closest</button>
        <button class="rounding-toggle-btn" id="roundUp" onclick="setRoundingMode('up')">Up</button>
      </div>
    </div>
    <div class="output-row output-row-last">
      <span>
      <span class="output-value" id="roundedWeight">--</span>
      <span class="output-label">lbs</span>
      </span>
      <span>
      <span class="output-value" id="roundedReps">--</span>
      <span class="output-label">reps</span>
      </span>
      <span>
      <span class="output-value" id="roundedRPE">--</span>
      <span class="output-label">RPE</span>
      </span>
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">Updated Targets</div>
    <div class="toggle-group">
      <button class="toggle-btn active" id="toggleWeight" onclick="setMode('weight')">Input Reps</button>
      <button class="toggle-btn" id="toggleReps" onclick="setMode('reps')">Input Weight</button>
    </div>
    <div class="input-row">
      <div class="input-group" id="targetRepsGroup">
        <label>Target Reps</label>
        <input type="number" id="targetReps" min="0" max="50" value="5">
        <div class="error-message" id="targetRepsError"></div>
      </div>
      <div class="input-group hidden" id="targetWeightGroup">
        <label>Target Weight</label>
        <input type="number" id="targetWeight" min="0" step="0.5" value="114">
        <div class="error-message" id="targetWeightError"></div>
      </div>
      <div class="input-group">
        <label>Target RPE</label>
        <input type="number" id="targetRPE" min="5" max="10" step="0.5" value="9">
        <div class="error-message" id="targetRPEError"></div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Reference Set</div>
    <div class="input-row">
      <div class="input-group">
        <label>Weight</label>
        <input type="number" id="refWeight" min="0" step="0.5" value="100">
        <div class="error-message" id="refWeightError"></div>
      </div>
      <div class="input-group">
        <label>Reps</label>
        <input type="number" id="refReps" min="0" max="50" value="10">
        <div class="error-message" id="refRepsError"></div>
      </div>
      <div class="input-group">
        <label>RPE</label>
        <input type="number" id="refRPE" min="5" max="10" step="0.5" value="9">
        <div class="error-message" id="refRPEError"></div>
      </div>
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Equipment</label>
        <select id="equipment">
          <option value="0">None</option>
          <option value="25">Smith Machine</option>
          <option value="167">45° Leg Press</option>
          <option value="dumbbells">Dumbbells (x1)</option>
          <option value="custom">Custom</option>
        </select>
        <div class="error-message"></div>
      </div>
    </div>
    <div class="input-row">
      <div class="input-group" id="customWeightGroup">
        <label>Base Weight</label>
        <input type="number" id="customWeight" min="0" step="0.5" value="0" disabled>
        <div class="error-message" id="customWeightError"></div>
      </div>
      <div class="input-group" id="weightIncrementGroup">
        <label>Increment</label>
        <input type="number" id="weightIncrement" min="0" step="0.5" value="5" disabled>
        <div class="error-message" id="weightIncrementError"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getPct, getRepsFromPct } from './src/calc.js';
    import { validateReps, validateWeight, validateRPE, validateIncrement, clearValidation } from './src/validation.js';
    import { getBaseWeight, clearOutputs, roundWeight, roundWeightDown, roundWeightUp, hasEnumeratedWeights, EQUIPMENT_CONFIG } from './src/utils.js';

    let mode = 'weight'; // 'weight' = calculate weight (user inputs reps), 'reps' = calculate reps (user inputs weight)
    let roundingMode = 'closest'; // 'down', 'closest', 'up'

    // Handle rounding mode selection
    window.setRoundingMode = function(newMode) {
      roundingMode = newMode;
      const toggle = document.getElementById('roundingToggle');
      toggle.classList.remove('mode-down', 'mode-closest', 'mode-up');
      toggle.classList.add('mode-' + newMode);
      document.getElementById('roundDown').classList.toggle('active', newMode === 'down');
      document.getElementById('roundClosest').classList.toggle('active', newMode === 'closest');
      document.getElementById('roundUp').classList.toggle('active', newMode === 'up');
      calculate();
    }

    // Handle equipment selection change
    function onEquipmentChange() {
      const equipmentSelect = document.getElementById('equipment');
      const customWeightInput = document.getElementById('customWeight');
      const incrementInput = document.getElementById('weightIncrement');
      const selectedValue = equipmentSelect.value;
      const isCustom = selectedValue === 'custom';
      const config = EQUIPMENT_CONFIG[selectedValue];

      // Handle base weight input
      if (isCustom) {
        // Enable input for custom equipment
        customWeightInput.disabled = false;
        customWeightInput.value = customWeightInput.value || '0';
      } else if (config) {
        // Disable input and populate with preset value
        customWeightInput.disabled = true;
        customWeightInput.value = config.baseWeight;
      } else {
        customWeightInput.disabled = true;
        customWeightInput.value = '0';
      }

      // Handle weight increment input
      if (config && config.weights) {
        // Enumerated weights (e.g., dumbbells) - show em dash, disable
        incrementInput.disabled = true;
        incrementInput.value = '';
        incrementInput.placeholder = '—';
      } else if (isCustom) {
        // Custom equipment - enable editing
        incrementInput.disabled = false;
        incrementInput.placeholder = '';
        incrementInput.value = incrementInput.value || '5';
      } else if (config) {
        // Preset equipment with increment
        incrementInput.disabled = true;
        incrementInput.placeholder = '';
        incrementInput.value = config.increment;
      } else {
        incrementInput.disabled = true;
        incrementInput.placeholder = '';
        incrementInput.value = '5';
      }

      // Clear validation on increment field when switching equipment
      clearValidation('weightIncrement');

      calculate();
    }

    // Make setMode available globally for onclick handlers
    window.setMode = function(newMode) {
      mode = newMode;
      document.querySelector('.toggle-group').classList.toggle('mode-reps', mode === 'reps');
      document.getElementById('toggleWeight').classList.toggle('active', mode === 'weight');
      document.getElementById('toggleReps').classList.toggle('active', mode === 'reps');
      // Show reps input when calculating weight, show weight input when calculating reps
      document.getElementById('targetRepsGroup').classList.toggle('hidden', mode === 'reps');
      document.getElementById('targetWeightGroup').classList.toggle('hidden', mode === 'weight');
      clearValidation('targetReps');
      clearValidation('targetWeight');
      calculate();
    }

    function calculate() {
      // Validate all inputs
      const refReps = validateReps('refReps');
      const refWeight = validateWeight('refWeight');
      const refRPE = validateRPE('refRPE');
      const targetRPE = validateRPE('targetRPE');

      let targetReps = null;
      let targetWeight = null;

      if (mode === 'weight') {
        // Calculating weight, user provides reps
        targetReps = validateReps('targetReps');
        clearValidation('targetWeight');
      } else {
        // Calculating reps, user provides weight
        targetWeight = validateWeight('targetWeight');
        clearValidation('targetReps');
      }

      // Check if any required validation failed
      if (refReps === null || refWeight === null || refRPE === null || targetRPE === null) {
        clearOutputs();
        return;
      }

      if (mode === 'weight' && targetReps === null) {
        clearOutputs();
        return;
      }

      if (mode === 'reps' && targetWeight === null) {
        clearOutputs();
        return;
      }

      // Get equipment base weight (for converting plate weight to total weight)
      const baseWeight = getBaseWeight();

      // Calculate estimated 1RM from reference set
      // User enters plate weight; total weight = plate weight + base weight
      // e1RM = totalWeight * pct / 100 (pct scales up to 1RM)
      const refPct = getPct(refReps, refRPE);
      const refTotalWeight = refWeight + baseWeight;
      const e1RM = refTotalWeight * refPct / 100;

      let outputReps, outputWeight;

      if (mode === 'weight') {
        // User provides target reps, calculate weight
        const targetPct = getPct(targetReps, targetRPE);
        const totalOutputWeight = e1RM * 100 / targetPct;
        outputWeight = totalOutputWeight - baseWeight; // Convert back to plate weight
        outputReps = targetReps;
      } else {
        // User provides target weight (plate weight), calculate reps
        const totalTargetWeight = targetWeight + baseWeight;
        const targetPct = e1RM * 100 / totalTargetWeight;
        outputReps = getRepsFromPct(targetPct, targetRPE);
        outputWeight = targetWeight; // Already plate weight
      }

      // Round outputs for display (and use these for further calculations)
      const displayWeight = Math.round(outputWeight * 10) / 10;
      const displayReps = Math.round(outputReps * 10) / 10;

      document.getElementById('outputReps').textContent = displayReps;
      document.getElementById('outputWeight').textContent = displayWeight;
      document.getElementById('outputRPE').textContent = targetRPE;

      // Calculate rounded weight based on rounding mode
      // Use displayWeight so rounded values are consistent with what user sees
      let roundedWeight;

      if (roundingMode === 'down') {
        roundedWeight = roundWeightDown(displayWeight);
      } else if (roundingMode === 'up') {
        roundedWeight = roundWeightUp(displayWeight);
      } else {
        // 'closest' mode: choose the direction that gives reps closest to exact
        const weightDown = roundWeightDown(displayWeight);
        const weightUp = roundWeightUp(displayWeight);

        // Calculate integer reps for each rounded weight
        const totalDown = weightDown + baseWeight;
        const pctDown = e1RM * 100 / totalDown;
        const repsDown = Math.round(getRepsFromPct(pctDown, targetRPE));

        const totalUp = weightUp + baseWeight;
        const pctUp = e1RM * 100 / totalUp;
        const repsUp = Math.round(getRepsFromPct(pctUp, targetRPE));

        // Choose the weight that gives reps closest to displayReps
        const diffDown = Math.abs(repsDown - displayReps);
        const diffUp = Math.abs(repsUp - displayReps);

        if (diffDown < diffUp) {
          roundedWeight = weightDown;
        } else if (diffUp < diffDown) {
          roundedWeight = weightUp;
        } else {
          // Reps are equal - use RPE as tiebreaker
          // Calculate adjusted RPE for each option
          const effectiveRepsDown = 1 + Math.log(pctDown / 100) / 0.0262;
          const rpeDown = 10 - (effectiveRepsDown - repsDown);

          const effectiveRepsUp = 1 + Math.log(pctUp / 100) / 0.0262;
          const rpeUp = 10 - (effectiveRepsUp - repsUp);

          // Choose the weight with RPE closer to target
          const rpeDiffDown = Math.abs(rpeDown - targetRPE);
          const rpeDiffUp = Math.abs(rpeUp - targetRPE);

          if (rpeDiffDown < rpeDiffUp) {
            roundedWeight = weightDown;
          } else if (rpeDiffUp < rpeDiffDown) {
            roundedWeight = weightUp;
          } else {
            // RPE also equal - use weight closest to exact
            const weightDiffDown = Math.abs(weightDown - displayWeight);
            const weightDiffUp = Math.abs(weightUp - displayWeight);
            roundedWeight = weightDiffDown <= weightDiffUp ? weightDown : weightUp;
          }
        }
      }

      // Calculate exact reps at rounded weight (using target RPE)
      const totalRoundedWeight = roundedWeight + baseWeight;
      const roundedPct = e1RM * 100 / totalRoundedWeight;
      const exactRepsAtRoundedWeight = getRepsFromPct(roundedPct, targetRPE);

      // Round reps to nearest integer
      const roundedReps = Math.round(exactRepsAtRoundedWeight);

      // Calculate adjusted RPE to account for reps rounding
      // effectiveReps = 1 + ln(pct / 100) / 0.0262
      // adjustedRPE = 10 - (effectiveReps - roundedReps)
      const effectiveReps = 1 + Math.log(roundedPct / 100) / 0.0262;
      const adjustedRPE = Math.round((10 - (effectiveReps - roundedReps)) * 10) / 10;

      document.getElementById('roundedWeight').textContent = Math.round(roundedWeight * 10) / 10;
      document.getElementById('roundedReps').textContent = roundedReps;
      document.getElementById('roundedRPE').textContent = adjustedRPE;

      // Sync hidden inputs with their corresponding outputs
      if (mode === 'weight') {
        // targetWeight is hidden, sync it with outputWeight
        document.getElementById('targetWeight').value = Math.round(outputWeight * 10) / 10;
      } else {
        // targetReps is hidden, sync it with outputReps
        document.getElementById('targetReps').value = Math.round(outputReps * 10) / 10;
      }
    }

    // Add event listeners to all inputs
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', calculate);
    });

    // Add event listener for equipment select
    document.getElementById('equipment').addEventListener('change', onEquipmentChange);

    // Initialize equipment state and calculate
    onEquipmentChange();

    // Register service worker for offline support (PWA)
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'setcalc-v2';
        const urlsToCache = [
          '/',
          '/index.html',
          '/src/calc.js',
          '/src/validation.js',
          '/src/utils.js'
        ];
        self.addEventListener('install', e => {
          e.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
          );
          self.skipWaiting();
        });
        self.addEventListener('activate', e => {
          e.waitUntil(
            caches.keys().then(keys =>
              Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
            )
          );
          self.clients.claim();
        });
        self.addEventListener('fetch', e => {
          e.respondWith(
            caches.match(e.request).then(r => r || fetch(e.request))
          );
        });
      `;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
    }
  </script>

</body>
</html>